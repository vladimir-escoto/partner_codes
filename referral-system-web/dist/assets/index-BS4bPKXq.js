(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const _t={version:1,seededAt:null},wt=[{id:"pt-console",name:"Partner Console"},{id:"affiliate-portal",name:"Affiliate Portal"},{id:"customer-app",name:"Customer App"}],bt=[],At=[],Nt=[],St=[],$t=[],vt={lastUserId:0,lastCodeId:0},xt={settings:_t,apps:wt,partners:bt,affiliates:At,users:Nt,codes:St,transactions:$t,counters:vt},ve="referral-system:db";let Qe=null;function Ze(){return typeof globalThis<"u"&&typeof globalThis.localStorage<"u"&&globalThis.localStorage!==null}function It(){return Ze()?globalThis.localStorage.getItem(ve):Qe}function et(e){if(Ze()){e===null?globalThis.localStorage.removeItem(ve):globalThis.localStorage.setItem(ve,e);return}Qe=e}function Tt(){const e=It();if(!e)return null;try{return JSON.parse(e)}catch(t){return console.warn("Failed to parse DB snapshot, resetting storage.",t),et(null),null}}function Pt(e){const t=JSON.stringify(e);return et(t),e}const Dt=["North America","Latin America","Europe","Asia Pacific"],Lt=["customer","merchant","ambassador","promoter"],Mt=["active","inactive","pending"],Rt=["Alex","Jordan","Camila","Diego","Sophie","Lucas","Maya","Mateo","Emma","Noah"],Ft=["Rivera","Johnson","Fernandez","Smith","Paredes","Hernandez","Lopez","Gonzalez","Keller","Williams"],Ut=60;function G(e){return e[Math.floor(Math.random()*e.length)]}function Bt(e){const t=Date.now(),n=e*24*60*60*1e3,a=Math.floor(Math.random()*n);return new Date(t-a).toISOString()}function Ht(){const e=new Date().toISOString();return[{id:"PT-001",name:"Terra Partners",shortName:"Terra",region:"Latin America",status:"active",createdAt:e},{id:"PT-002",name:"Nova Growth",shortName:"Nova",region:"Europe",status:"active",createdAt:e}]}function Ot(e){const[t]=e,n=new Date().toISOString();return[{id:"AF-001",partnerId:t.id,name:"Horizons Media",region:"Mexico",status:"active",createdAt:n},{id:"AF-002",partnerId:t.id,name:"Pulse Digital",region:"Chile",status:"active",createdAt:n}]}function zt({userId:e,codeId:t,affiliate:n,partner:a,app:r,createdAt:s}){const o=G(Rt),c=G(Ft),i=`${o}.${c}${e}@example.com`.toLowerCase();return{id:e,partnerId:a.id,affiliateId:n.id,appId:r.id,codeId:t,firstName:o,lastName:c,email:i,region:G(Dt),type:G(Lt),status:G(Mt),createdAt:s}}function Vt({codeId:e,userId:t,affiliate:n,partner:a,app:r,createdAt:s}){return{id:e,value:`${n.id}-${String(e).padStart(4,"0")}`,partnerId:a.id,affiliateId:n.id,userId:t,appId:r.id,createdAt:s}}function Wt({affiliates:e,partners:t,apps:n,count:a}){const r=[],s=[];let o=0,c=0;for(let i=0;i<a;i+=1){const p=e[Math.floor(Math.random()*e.length)],l=t.find(h=>h.id===p.partnerId)||t[0],u=n[i%n.length],d=Bt(120);o+=1,c+=1;const m=zt({userId:o,codeId:c,affiliate:p,partner:l,app:u,createdAt:d}),f=Vt({codeId:c,userId:o,affiliate:p,partner:l,app:u,createdAt:d});r.push(m),s.push(f)}return{users:r,codes:s,lastUserId:o,lastCodeId:c}}function jt(){return JSON.parse(JSON.stringify(xt))}function Kt(){const e=Tt();if(e&&Array.isArray(e.users)&&e.users.length>0)return e;const t=jt(),n=Ht(),a=Ot(n),{users:r,codes:s,lastUserId:o,lastCodeId:c}=Wt({affiliates:a,partners:n,apps:t.apps,count:Ut});return t.settings.seededAt=new Date().toISOString(),t.partners=n,t.affiliates=a,t.users=r,t.codes=s,t.counters.lastUserId=o,t.counters.lastCodeId=c,Pt(t),t}const tt="referral-system-db",qt={users:[],codes:[],invoices:[],reports:[]},Yt=typeof structuredClone=="function",Gt=e=>Yt?structuredClone(e):JSON.parse(JSON.stringify(e));let b;const re=()=>Gt(qt),nt=()=>{if(b)return b;if(typeof window>"u"||!window.localStorage)return b=re(),b;const e=window.localStorage.getItem(tt);let t=!1;if(!e)b=re(),t=!0;else try{const n=JSON.parse(e);n&&typeof n=="object"?b=n:(b=re(),t=!0)}catch{b=re(),t=!0}return t&&at(b),b},at=e=>{const t=typeof e>"u"?$():e;b=t,!(typeof window>"u"||!window.localStorage)&&window.localStorage.setItem(tt,JSON.stringify(t))},$=()=>b||nt(),ne=e=>{if(typeof e!="function")throw new TypeError("setDB(updater) expects a function as the updater argument.");const t=$(),n=e(t);return typeof n<"u"?b=n:b=t,at(b),b},ze=[{id:"admin",label:"Admin"},{id:"ejecutivo",label:"Ejecutivo"},{id:"finanzas",label:"Finanzas"},{id:"partner",label:"Partner"}],D="ui-sidebar",he=e=>(e||"").toString().trim().toLowerCase(),we=e=>(e??"").toString().trim(),Xt=e=>{if(typeof e=="string")return{id:he(e),label:e};const t=he((e==null?void 0:e.id)??(e==null?void 0:e.value)??(e==null?void 0:e.role)),n=(e==null?void 0:e.label)||(e==null?void 0:e.name)||(e==null?void 0:e.title)||(e==null?void 0:e.id)||(e==null?void 0:e.value)||"Rol";return{id:t,label:n}};function Jt({roles:e=ze,activeRole:t=ze[0].id,activeView:n=null,title:a="Menú de navegación",onRoleChange:r,onViewChange:s,getViewsForRole:o}={}){var I;const c=Array.from(new Map(e.map(g=>{const y=Xt(g);return[y.id,y]})).values());let i={role:he(t)||((I=c[0])==null?void 0:I.id)||"admin",view:we(n)};const p=new Map,l=new Map,u=document.createElement("aside");u.className=D,u.setAttribute("data-role",i.role);const d=document.createElement("h2");d.className=`${D}__title`,d.textContent=a,u.appendChild(d);const m=document.createElement("div");m.className=`${D}__roles`,c.forEach(g=>{const y=document.createElement("button");y.type="button",y.className=`${D}__role`,y.textContent=g.label,y.dataset.role=g.id,y.addEventListener("click",()=>{i.role!==g.id&&(_(g.id),typeof r=="function"&&r(g.id))}),p.set(g.id,y),m.appendChild(y)}),u.appendChild(m);const f=document.createElement("nav");f.className=`${D}__nav`,f.setAttribute("aria-label","Menú contextual de vistas");const h=document.createElement("ul");h.className=`${D}__list`,f.appendChild(h),u.appendChild(f);const C=()=>{h.innerHTML="";const g=document.createElement("li");g.className=`${D}__item ${D}__item--empty`,g.textContent="Sin vistas disponibles.",h.appendChild(g)},E=g=>{const y=we(g);i={...i,view:y},l.forEach((A,S)=>{S===y?(A.classList.add("is-active"),A.setAttribute("aria-current","page")):(A.classList.remove("is-active"),A.removeAttribute("aria-current"))})},N=g=>{if(h.innerHTML="",l.clear(),!Array.isArray(g)||g.length===0){C();return}if(g.forEach(({id:y,label:A})=>{const S=we(y),T=document.createElement("li");T.className=`${D}__item`;const x=document.createElement("button");x.type="button",x.className=`${D}__link`,x.textContent=A??S,x.dataset.view=S,x.addEventListener("click",()=>{E(S),typeof s=="function"&&s(i.role,S)}),T.appendChild(x),h.appendChild(T),l.set(S,x)}),i.view&&l.has(i.view))E(i.view);else{const y=l.keys().next().value;y&&E(y)}},_=(g,{views:y}={})=>{const A=he(g);if(!A)return;i={...i,role:A},u.setAttribute("data-role",A),p.forEach((T,x)=>{x===A?(T.classList.add("is-active"),T.setAttribute("aria-current","true")):(T.classList.remove("is-active"),T.removeAttribute("aria-current"))});const S=Array.isArray(y)?y:typeof o=="function"?o(A):[];N(S)},w=()=>{_(i.role)};return _(i.role,{views:typeof o=="function"?o(i.role):[]}),i.view&&E(i.view),{element:u,setActiveRole:_,setActiveView:E,refreshViews:w}}const Ee=e=>(e??"").toString().trim().toLowerCase(),rt=e=>(e??"").toString().trim(),k=new Map;let F=null,H={role:null,view:null};const kt=e=>{const t=Ee(e);return k.has(t)||k.set(t,{order:[],views:new Map}),k.get(t)},Ve=e=>{if(!F)return;F.innerHTML="";const t=document.createElement("section");t.className="card";const n=document.createElement("h2");n.textContent="Vista no disponible",t.appendChild(n);const a=document.createElement("p");a.textContent=e,t.appendChild(a),F.appendChild(t)},Qt=e=>{if(!(e instanceof HTMLElement))throw new TypeError("setContentContainer(node) espera un elemento HTML.");F=e},Zt=({role:e,view:t,label:n,render:a})=>{const r=Ee(e),s=rt(t);if(!r)throw new Error("registerRoute requiere un rol válido.");if(!s)throw new Error("registerRoute requiere una vista con identificador.");if(typeof a!="function")throw new TypeError(`registerRoute("${r}", "${s}") espera una función render.`);const o=kt(r);o.views.has(s)||o.order.push(s),o.views.set(s,{label:n||s,render:a})},en=(e,t)=>{if(!Array.isArray(t))throw new TypeError("registerRoutes(role, views) espera un arreglo de vistas.");t.forEach(n=>{Zt({role:e,...n})})},oe=e=>{const t=Ee(e),n=k.get(t);return n?n.order.map(a=>{const r=n.views.get(a);return{id:a,label:(r==null?void 0:r.label)??a}}):[]},ue=(e,t)=>{if(!F)throw new Error("navigate(role, view) requiere un contenedor de contenido configurado.");const n=Ee(e),a=k.get(n);if(!a||a.order.length===0)return H={role:n||null,view:null},Ve(`No se encontraron vistas configuradas para el rol "${e??"desconocido"}".`),{...H};let r=rt(t);(!r||!a.views.has(r))&&([r]=a.order);const s=a.views.get(r);return s?(F.innerHTML="",s.render(F,{role:n,view:r,navigate:ue}),H={role:n,view:r},{...H}):(H={role:n,view:r},Ve(`La vista "${r}" no está registrada para el rol "${e}".`),{...H})},be="standard",tn=.25,ye=(e,t=null)=>{if(e==null||e==="")return t;if(typeof e=="string"){const a=e.trim();if(a==="")return t;const r=a.endsWith("%")?a.slice(0,-1):a,s=Number(r);return Number.isFinite(s)?s:t}const n=Number(e);return Number.isFinite(n)?n:t},Ae=e=>{const t=ye(e,0);if(t==null)return 0;const n=Number.isFinite(t)?t:0,a=n<0?0:n;return Math.round(a*100)/100},nn=(e={})=>{const t=e.accountType??e.account_type??e.segment??e.tier??e.plan??be;return typeof t!="string"?be:t.trim().toLowerCase()||be},ot=e=>Array.isArray(e)?e:[],st=(e,t)=>{if(!(!e||typeof e!="object"))return t.reduce((n,a)=>{if(n!=null)return n[a]},e)},lt=(e,t)=>{for(const n of t){const a=st(e,n);if(a&&typeof a=="object")return a}return null},an=[["payout_base"],["payouts","base"],["settings","payout_base"],["settings","payouts","base"],["config","payout_base"],["config","payouts","base"]],rn=[["payout_affiliate"],["payouts","affiliate"],["settings","payout_affiliate"],["settings","payouts","affiliate"],["config","payout_affiliate"],["config","payouts","affiliate"]],on=e=>typeof e!="string"?null:e.trim().toLowerCase(),We=(e,t,n=0)=>{if(!e||typeof e!="object")return n;const a=on(t),r=[a,a&&a.toUpperCase(),a&&a.replace(/[-\s]/g,"_"),a&&a.replace(/[-\s]/g,""),"default","DEFAULT","*"].filter(Boolean);for(const s of r)if(s in e){const o=e[s],c=ye(o,null);if(c!=null)return c}return n},ct=(e,t=null)=>{for(const n of e){const a=ye(n,null);if(a!=null)return a}return t},sn=e=>{const t=ye(e,null);return t==null||t<0?null:t>1?t<=100?t/100:null:t},B=e=>e==null?null:typeof e=="number"?e:typeof e=="string"?e.trim():null,ln=(e,t)=>{const n=B(e);return n==null?null:ot(t==null?void 0:t.partners).find(a=>{const r=B((a==null?void 0:a.id)??(a==null?void 0:a.partnerId)??(a==null?void 0:a.partner_id));return r!=null&&r===n})??null},cn=(e,t)=>{const n=B(e);return n==null?null:ot(t==null?void 0:t.affiliates).find(a=>{const r=B((a==null?void 0:a.id)??(a==null?void 0:a.affiliateId)??(a==null?void 0:a.affiliate_id));return r!=null&&r===n})??null},dn=(e,t)=>{var p,l,u,d,m,f,h;const n=B((e==null?void 0:e.partnerId)??(e==null?void 0:e.partner_id)??(e==null?void 0:e.parent_partner_id)??(e==null?void 0:e.partner)),a=B((e==null?void 0:e.affiliateId)??(e==null?void 0:e.affiliate_id)??(e==null?void 0:e.affiliate)),r=n?ln(n,t):null,s=a?cn(a,t):null,c=ct([["partner_cut"],["payouts","partner_cut"],["settings","partner_cut"],["settings","payouts","partner_cut"],["settings","billing","partner_cut"],["config","partner_cut"],["config","payouts","partner_cut"],["defaults","partner_cut"]].map(C=>st(t,C)).filter(C=>C!=null),null),i=[e==null?void 0:e.partnerCut,e==null?void 0:e.partner_cut,(p=e==null?void 0:e.commission)==null?void 0:p.partner,e==null?void 0:e.commission_partner,(l=e==null?void 0:e.payout)==null?void 0:l.partnerCut,(u=e==null?void 0:e.payout)==null?void 0:u.partner_cut,e==null?void 0:e.partner_payout_cut,r==null?void 0:r.partnerCut,r==null?void 0:r.partner_cut,(d=r==null?void 0:r.settings)==null?void 0:d.partner_cut,(m=r==null?void 0:r.commission)==null?void 0:m.partner,(f=r==null?void 0:r.payout)==null?void 0:f.partner_cut,r==null?void 0:r.share,s==null?void 0:s.partnerCut,s==null?void 0:s.partner_cut,(h=s==null?void 0:s.settings)==null?void 0:h.partner_cut,c].filter(C=>C!=null);for(const C of i){const E=sn(C);if(E!=null)return E}return tn},je=(e,t)=>{if(!e||typeof e!="object")return null;const n=e.payoutOverride??e.payout_override??e.payout??e.payouts??null,a=[t,`${t}Amount`,`${t}_amount`,`${t}Payout`,`${t}_payout`,`${t}Override`,`${t}_override`,`${t}Value`,`${t}_value`],r=[e==null?void 0:e[`${t}PayoutOverride`],e==null?void 0:e[`${t}_payout_override`],e==null?void 0:e[`${t}Payout`],e==null?void 0:e[`${t}_payout`],e==null?void 0:e[`${t}Override`],e==null?void 0:e[`${t}_override`]];if(n&&typeof n=="object")for(const s of a)s in n&&r.push(n[s]);return ct(r,null)},un=(e={})=>{const t=e.code??e.codeValue??e.code_value??e.inviteCode??e.invite_code??null;return typeof t=="string"?t.trim():null},pn=(e={})=>{const t=e.role??e.roleCode??e.role_code??e.userType??null;if(typeof t=="string"){const r=t.trim().toUpperCase();if(r==="AF"||r==="AFFILIATE"||r==="AFFILIATED")return!0;if(r==="PT"||r==="PARTNER")return!1}const n=B(e.affiliateId??e.affiliate_id??e.parent_affiliate_id);if(n!=null&&n!==""&&n!==0)return!0;const a=un(e);if(a){const r=a.toUpperCase();if(r.startsWith("AF")||r.includes("AF-"))return!0;if(r.startsWith("PT")||r.includes("PT-"))return!1}return!1},mn=e=>lt(e,an),fn=e=>lt(e,rn);function Le(e,t={}){if(!e||typeof e!="object")return{partner:0,affiliate:0};const n=nn(e),a=je(e,"partner"),r=je(e,"affiliate"),s=mn(t),o=fn(t);if(!pn(e)){const m=We(s,n,0);return{affiliate:0,partner:Ae(a??m)}}const i=We(o,n,0),p=r??i,l=dn(e,t),u=p*l,d=a??u;return{affiliate:Ae(p),partner:Ae(d)}}const it=e=>{if(e instanceof Date)return new Date(e.getTime());if(typeof e=="string"||typeof e=="number"){const t=new Date(e);if(Number.isNaN(t.getTime()))throw new TypeError("Fecha inválida");return t}if(e===void 0)return new Date;throw new TypeError("Tipo de fecha no soportado")},xe=e=>String(e).padStart(2,"0"),hn=()=>ee(new Date),ee=e=>{const t=it(e),n=t.getFullYear(),a=xe(t.getMonth()+1),r=xe(t.getDate());return`${n}-${a}-${r}`},ae=e=>{const t=it(e),n=t.getFullYear(),a=xe(t.getMonth()+1);return`${n}-${a}`};if(typeof window<"u")try{const e=new Date("2024-01-02");console.assert(ee(e)==="2024-01-02","ymd(...) debería devolver YYYY-MM-DD"),console.assert(ae(e)==="2024-01","monthKey(...) debería devolver YYYY-MM"),console.assert(typeof hn()=="string","todayISO(...) debería devolver una cadena")}catch(e){console.warn("Fallo en comprobaciones de dates.js:",e)}const U=e=>Array.isArray(e)?e:[],te=()=>({partner:0,affiliate:0,total:0}),R=e=>({partner:e.partner,affiliate:e.affiliate,total:e.total}),V=(e,t)=>(e.partner+=t.partner,e.affiliate+=t.affiliate,e.total=e.partner+e.affiliate,e),se=(e={})=>({users:0,payout:te(),...e}),L=e=>e==null?null:typeof e=="number"?e:typeof e=="string"?e.trim():null,dt=e=>{try{return ae(e)}catch{return"unknown"}},gn=(e,t)=>{const n=L(e);return n==null?null:U(t==null?void 0:t.apps).find(a=>{const r=L((a==null?void 0:a.id)??(a==null?void 0:a.appId)??(a==null?void 0:a.app_id));return r!=null&&r===n})??null},Ie=(e,t={})=>{const{includeEntityId:n=!0}=t,a=[e==null?void 0:e.partnerId,e==null?void 0:e.partner_id,e==null?void 0:e.parentPartnerId,e==null?void 0:e.parent_partner_id,e==null?void 0:e.ownerPartnerId,e==null?void 0:e.owner_partner_id];for(const r of a){const s=L(r);if(s!=null)return s}if(n){const r=L((e==null?void 0:e.id)??(e==null?void 0:e.partner)??(e==null?void 0:e.code)??(e==null?void 0:e.identifier));if(r!=null)return r}return null},ut=(e,t={})=>{const{includeEntityId:n=!0}=t,a=[e==null?void 0:e.affiliateId,e==null?void 0:e.affiliate_id,e==null?void 0:e.parentAffiliateId,e==null?void 0:e.parent_affiliate_id,e==null?void 0:e.ownerAffiliateId,e==null?void 0:e.owner_affiliate_id];for(const r of a){const s=L(r);if(s!=null)return s}if(n){const r=L((e==null?void 0:e.id)??(e==null?void 0:e.affiliate)??(e==null?void 0:e.code)??(e==null?void 0:e.identifier));if(r!=null)return r}return null};function Me(e={}){const t=U(e==null?void 0:e.users),n=se(),a=new Map,r=new Map,s=new Map;for(const l of t){const u=Le(l,e);n.users+=1,V(n.payout,u);const d=L((l==null?void 0:l.appId)??(l==null?void 0:l.app_id)??(l==null?void 0:l.applicationId)),m=d!=null?gn(d,e):null,f=d??"unknown";a.has(f)||a.set(f,se({id:f,name:(m==null?void 0:m.name)??(m==null?void 0:m.label)??f??"Unknown"}));const h=a.get(f);h.users+=1,V(h.payout,u);const C=dt((l==null?void 0:l.createdAt)??(l==null?void 0:l.created_at)??(l==null?void 0:l.joinedAt));r.has(C)||r.set(C,se({month:C}));const E=r.get(C);E.users+=1,V(E.payout,u);const N=typeof(l==null?void 0:l.region)=="string"&&l.region.trim()||"Unknown";s.has(N)||s.set(N,se({region:N}));const _=s.get(N);_.users+=1,V(_.payout,u)}const o=l=>l.sort((u,d)=>{if(u.users===d.users){const m=u.name??u.region??u.id??"",f=d.name??d.region??d.id??"";return m.localeCompare(f)}return d.users-u.users}),c=o(Array.from(a.values())),i=o(Array.from(s.values())),p=Array.from(r.values()).sort((l,u)=>l.month==="unknown"?1:u.month==="unknown"?-1:l.month.localeCompare(u.month));return{totals:{users:n.users,payout:R(n.payout)},byApp:c.map(l=>({id:l.id,name:l.name,users:l.users,payout:R(l.payout)})),byMonth:p.map(l=>({month:l.month,users:l.users,payout:R(l.payout)})),byRegion:i.map(l=>({region:l.region,users:l.users,payout:R(l.payout)})),partnersCount:U(e==null?void 0:e.partners).length,affiliatesCount:U(e==null?void 0:e.affiliates).length}}const Cn=()=>({direct:te(),fromAffiliates:{partner:0,affiliate:0,total:0},overall:te()}),En=(e,t,n)=>(n==="direct"?V(e.direct,t):(e.fromAffiliates.partner+=t.partner,e.fromAffiliates.affiliate+=t.affiliate,e.fromAffiliates.total=e.fromAffiliates.partner+e.fromAffiliates.affiliate),e.overall.partner=e.direct.partner+e.fromAffiliates.partner,e.overall.affiliate=e.fromAffiliates.affiliate,e.overall.total=e.overall.partner+e.overall.affiliate,e),yn=e=>({month:e,users:{direct:0,affiliates:0,total:0},payouts:{direct:te(),affiliates:{partner:0,affiliate:0,total:0},overall:te()}}),_n=(e,t,n)=>(n==="direct"?(e.users.direct+=1,V(e.payouts.direct,t)):(e.users.affiliates+=1,e.payouts.affiliates.partner+=t.partner,e.payouts.affiliates.affiliate+=t.affiliate,e.payouts.affiliates.total=e.payouts.affiliates.partner+e.payouts.affiliates.affiliate),e.users.total=e.users.direct+e.users.affiliates,e.payouts.overall.partner=e.payouts.direct.partner+e.payouts.affiliates.partner,e.payouts.overall.affiliate=e.payouts.affiliates.affiliate,e.payouts.overall.total=e.payouts.overall.partner+e.payouts.overall.affiliate,e),wn=(e,t=null)=>{if(!e||typeof e!="object")return t!=null?{id:t}:null;const n=Ie(e)??t??null,a=e.name??e.partnerName??null,r=e.shortName??e.short_name??null,s=e.region??e.partnerRegion??null,o=e.status??e.partnerStatus??null;return{id:n,name:a,shortName:r,region:s,status:o}},bn=e=>{if(!e||typeof e!="object")return null;const t=ut(e),n=e.name??e.affiliateName??null,a=e.region??e.affiliateRegion??null,r=e.status??e.affiliateStatus??null;return{id:t,name:n,region:a,status:r}};function An(e,t={}){const n=L(e),a=U(t==null?void 0:t.partners).find(l=>{const u=Ie(l);return u!=null&&u===n})??null,r=U(t==null?void 0:t.affiliates).filter(l=>{const u=Ie(l,{includeEntityId:!1});return u!=null&&u===n}),s=new Set(r.map(l=>ut(l)).filter(Boolean)),o=U(t==null?void 0:t.users).filter(l=>{const u=L((l==null?void 0:l.partnerId)??(l==null?void 0:l.partner_id)??(l==null?void 0:l.parent_partner_id));return!(u==null||u!==n)}),c={users:{direct:0,affiliates:0,total:0},payouts:Cn()},i=new Map;for(const l of o){const u=Le(l,t),d=L((l==null?void 0:l.affiliateId)??(l==null?void 0:l.affiliate_id)??(l==null?void 0:l.parent_affiliate_id)),m=d!=null&&s.has(d)?"affiliate":"direct";m==="direct"?c.users.direct+=1:c.users.affiliates+=1,c.users.total+=1,En(c.payouts,u,m==="direct"?"direct":"affiliate");const f=dt((l==null?void 0:l.createdAt)??(l==null?void 0:l.created_at)??(l==null?void 0:l.joinedAt));i.has(f)||i.set(f,yn(f));const h=i.get(f);_n(h,u,m==="direct"?"direct":"affiliate")}const p=Array.from(i.values()).sort((l,u)=>l.month==="unknown"?1:u.month==="unknown"?-1:l.month.localeCompare(u.month));return{partner:wn(a,n),totals:{users:{...c.users},payouts:{direct:R(c.payouts.direct),fromAffiliates:{partner:c.payouts.fromAffiliates.partner,affiliate:c.payouts.fromAffiliates.affiliate,total:c.payouts.fromAffiliates.total},overall:R(c.payouts.overall)}},monthlySeries:p.map(l=>({month:l.month,users:{...l.users},payouts:{direct:R(l.payouts.direct),affiliates:{partner:l.payouts.affiliates.partner,affiliate:l.payouts.affiliates.affiliate,total:l.payouts.affiliates.total},overall:R(l.payouts.overall)}})),affiliates:r.map(bn).filter(l=>l&&l.id!=null)}}const Q="ui-kpi-card";function Nn(e,{prefix:t="",suffix:n=""}={}){if(e==null)return"—";if(typeof e=="number"){const a=e.toLocaleString("es-ES",{maximumFractionDigits:2,minimumFractionDigits:e%1===0?0:2});return`${t}${a}${n}`}return`${t}${e}${n}`}function Sn(e,t,n){const a=document.createElement("article");a.className=Q;const r=document.createElement("p");r.className=`${Q}__label`,r.textContent=e;const s=document.createElement("p");return s.className=`${Q}__value`,s.textContent=Nn(t,n),a.appendChild(r),a.appendChild(s),a}function $n({label:e,value:t,prefix:n,suffix:a,modifier:r}){const s=Sn(e,t,{prefix:n,suffix:a});return r&&s.classList.add(`${Q}--${r}`),s}function Re(e,t=[]){if(!(e instanceof HTMLElement))throw new Error("Se requiere un contenedor HTMLElement para renderizar las tarjetas KPI.");e.classList.add(`${Q}__grid`),e.innerHTML="",t.forEach(n=>{const a=$n(n);e.appendChild(a)})}const vn=[{label:"Q1",value:12},{label:"Q2",value:18},{label:"Q3",value:9},{label:"Q4",value:15}],xn=[{label:"Ene",value:5},{label:"Feb",value:7},{label:"Mar",value:6},{label:"Abr",value:9},{label:"May",value:11},{label:"Jun",value:10}],In=[[12,18,9,15],[8,5,13,7],[16,11,6,10]];function pt(e,t){return!Array.isArray(e)||!e.length?t:e}function mt(e,t){return pt(e,t).map((a,r)=>typeof a=="number"?{label:`Serie ${r+1}`,value:a}:{label:a.label??`Serie ${r+1}`,value:Number(a.value??0)})}function Tn(e){const t=typeof e=="string"?document.querySelector(e):e;if(!(t instanceof HTMLCanvasElement))throw new Error("Se requiere un elemento <canvas> válido para dibujar el gráfico.");return t}function Fe(e){const t=Tn(e),n=t.getContext("2d"),a=window.devicePixelRatio||1,r=t.clientWidth||t.width||320,s=t.clientHeight||t.height||200;return t.width!==r*a&&(t.width=r*a),t.height!==s*a&&(t.height=s*a),n.setTransform(a,0,0,a,0,0),n.clearRect(0,0,r,s),n.font="12px sans-serif",n.fillStyle="#1f2937",n.strokeStyle="#4b5563",n.lineWidth=1,{ctx:n,width:r,height:s}}function Te(e,t){const{ctx:n,width:a,height:r}=Fe(e),s=mt(t,vn),o=32,c=r-o*2,p=(a-o*2)/s.length,l=Math.max(...s.map(u=>u.value),1);n.beginPath(),n.moveTo(o,o),n.lineTo(o,r-o),n.lineTo(a-o/2,r-o),n.stroke(),s.forEach((u,d)=>{const m=o+p*d+p*.1,f=u.value/l*c,h=r-o-f;n.fillStyle="#2563eb",n.fillRect(m,h,p*.8,f),n.fillStyle="#1f2937",n.textAlign="center",n.fillText(u.label,m+p*.4,r-o+14),n.fillText(u.value.toString(),m+p*.4,h-6)})}function _e(e,t){const{ctx:n,width:a,height:r}=Fe(e),s=mt(t,xn),o=32,c=r-o*2,i=a-o*2,p=Math.max(...s.map(u=>u.value),1),l=i/(s.length-1||1);n.beginPath(),n.moveTo(o,o),n.lineTo(o,r-o),n.lineTo(a-o/2,r-o),n.stroke(),n.strokeStyle="#16a34a",n.lineWidth=2,n.beginPath(),s.forEach((u,d)=>{const m=o+l*d,f=r-o-u.value/p*c;d===0?n.moveTo(m,f):n.lineTo(m,f)}),n.stroke(),n.fillStyle="#16a34a",s.forEach((u,d)=>{const m=o+l*d,f=r-o-u.value/p*c;n.beginPath(),n.arc(m,f,4,0,Math.PI*2),n.fill(),n.fillStyle="#1f2937",n.textAlign="center",n.fillText(u.label,m,r-o+14),n.fillText(u.value.toString(),m,f-8),n.fillStyle="#16a34a"})}function Pn(e){return e.reduce((t,n)=>t.concat(n),[])}function Dn(e,t,n){const a=n===t?.5:(e-t)/(n-t),r=[219,234,254],s=[30,64,175],o=c=>Math.round(r[c]+(s[c]-r[c])*a);return`rgb(${o(0)}, ${o(1)}, ${o(2)})`}function Ln(e,t){var C;const{ctx:n,width:a,height:r}=Fe(e),s=pt(t,In),o=s.length,c=((C=s[0])==null?void 0:C.length)||1,i=24,p=a-i*2,l=r-i*2,u=p/c,d=l/o,m=Pn(s),f=Math.min(...m),h=Math.max(...m);s.forEach((E,N)=>{E.forEach((_,w)=>{const I=i+w*u,g=i+N*d;n.fillStyle=Dn(_,f,h),n.fillRect(I,g,u,d),n.strokeStyle="#f9fafb",n.strokeRect(I,g,u,d),n.fillStyle=_>(f+h)/2?"#f9fafb":"#1f2937",n.textAlign="center",n.textBaseline="middle",n.fillText(_.toString(),I+u/2,g+d/2)})})}const Mn=e=>{if(!e||e==="unknown")return"Sin dato";const[t,n]=e.split("-");return new Date(Date.UTC(Number(t),Number(n)-1,1)).toLocaleDateString("es-MX",{month:"short",year:"numeric"})},le=e=>{const t=document.createElement("article");if(t.className="card",e){const n=document.createElement("h2");n.textContent=e,t.appendChild(n)}return t},Rn=(e,t)=>{const n=new Map;e.forEach(o=>{const c=typeof(o==null?void 0:o.region)=="string"&&o.region.trim()?o.region.trim():"Unknown";n.has(c)||n.set(c,new Map);const i=ae((o==null?void 0:o.createdAt)??(o==null?void 0:o.created_at)??(o==null?void 0:o.joinedAt)??new Date),p=n.get(c);p.set(i,(p.get(i)??0)+1)});const a=Array.from(n.entries()).map(([o,c])=>({region:o,total:Array.from(c.values()).reduce((i,p)=>i+p,0),bucket:c})).sort((o,c)=>c.total-o.total).slice(0,5),r=a.map(({bucket:o})=>t.map(c=>o.get(c)??0)),s=a.map(o=>o.region);return{matrix:r,labels:s}};function Fn(e){const t=$(),n=Me(t),a=document.createElement("header");a.className="card",a.innerHTML=`
    <h1>Dashboard administrativo</h1>
    <p>Resumen global del ecosistema de referidos, actividad por aplicaciones y distribución regional.</p>
  `,e.appendChild(a);const r=le("Indicadores principales"),s=document.createElement("div");Re(s,[{label:"Usuarios totales",value:n.totals.users},{label:"Payout partners",value:n.totals.payout.partner,prefix:"$"},{label:"Payout afiliados",value:n.totals.payout.affiliate,prefix:"$"},{label:"Partners / Afiliados",value:`${n.partnersCount} / ${n.affiliatesCount}`}]),r.appendChild(s),e.appendChild(r);const o=document.createElement("div");o.className="grid grid--two";const c=le("Usuarios por aplicación"),i=document.createElement("canvas");i.height=240,c.appendChild(i),o.appendChild(c);const p=le("Serie mensual de usuarios"),l=document.createElement("canvas");l.height=240,p.appendChild(l),o.appendChild(p),e.appendChild(o);const u=le("Actividad por región (últimos meses)"),d=document.createElement("canvas");d.height=280,u.appendChild(d);const m=document.createElement("p");m.className="card__legend",u.appendChild(m),e.appendChild(u);const f=n.byApp.map(w=>({label:w.name??w.id,value:w.users}));Te(i,f);const h=n.byMonth.slice(-12),C=h.map(w=>({label:Mn(w.month),value:w.users}));_e(l,C);const E=h.map(w=>w.month??"unknown"),{matrix:N,labels:_}=Rn(t.users??[],E);Ln(d,N),_.length?m.textContent=`Filas: ${_.join(" · ")} | Columnas: ${C.map(w=>w.label).join(" · ")}`:m.textContent="Sin datos suficientes para la distribución regional."}const Ke="ui-toast-container",W="ui-toast",Un=3500;function Bn(){let e=document.getElementById(Ke);return e||(e=document.createElement("section"),e.id=Ke,e.className=`${W}__container`,e.setAttribute("aria-live","assertive"),e.setAttribute("aria-atomic","true"),document.body.appendChild(e)),e}function Hn(e,{type:t,dismissible:n}){const a=document.createElement("article");a.className=`${W} ${W}--${t}`,a.setAttribute("role","status");const r=document.createElement("p");if(r.className=`${W}__message`,r.textContent=e,a.appendChild(r),n){const s=document.createElement("button");s.type="button",s.className=`${W}__close`,s.setAttribute("aria-label","Cerrar notificación"),s.innerHTML="&times;",s.addEventListener("click",()=>Pe(a)),a.appendChild(s)}return a.addEventListener("animationend",s=>{s.animationName==="hideToast"&&Pe(a)}),a}function Pe(e){e.classList.add(`${W}--leaving`),setTimeout(()=>{e.remove()},250)}function v(e,{type:t="info",duration:n=Un,dismissible:a=!0}={}){const r=Bn(),s=Hn(e,{type:t,dismissible:a});return r.appendChild(s),n>0&&setTimeout(()=>Pe(s),n),s}const q=new Map,Ue="ui-modal-overlay",M="ui-modal";function ft(e,t=document.body){e.isConnected||t.appendChild(e)}function On({label:e,onClick:t,variant:n="primary"}){const a=document.createElement("button");return a.type="button",a.className=`${M}__action ${M}__action--${n}`,a.textContent=e,typeof t=="function"&&a.addEventListener("click",t),a}function zn(e,t){t!=null&&(typeof t=="string"?e.innerHTML=t:t instanceof HTMLElement?(e.innerHTML="",e.appendChild(t)):Array.isArray(t)&&(e.innerHTML="",t.forEach(n=>{if(typeof n=="string"){const a=document.createElement("p");a.textContent=n,e.appendChild(a)}else n instanceof HTMLElement&&e.appendChild(n)})))}function Vn({id:e,title:t,content:n,actions:a=[],closeOnOverlay:r=!0,container:s}={}){const o=e||`modal-${q.size+1}`,c=document.createElement("div");c.className=Ue,c.dataset.modalId=o,c.setAttribute("role","presentation");const i=document.createElement("section");i.className=M,i.setAttribute("role","dialog"),i.setAttribute("aria-modal","true"),i.setAttribute("aria-labelledby",`${o}-title`);const p=document.createElement("header");p.className=`${M}__header`;const l=document.createElement("h3");l.className=`${M}__title`,l.id=`${o}-title`,l.textContent=t||"Modal";const u=document.createElement("button");u.type="button",u.className=`${M}__close`,u.setAttribute("aria-label","Cerrar modal"),u.innerHTML="&times;",u.addEventListener("click",()=>ge(o)),p.appendChild(l),p.appendChild(u);const d=document.createElement("div");d.className=`${M}__body`,zn(d,n);const m=document.createElement("footer");return m.className=`${M}__footer`,a.forEach(f=>m.appendChild(On(f))),i.appendChild(p),i.appendChild(d),a.length&&i.appendChild(m),c.appendChild(i),r&&c.addEventListener("click",f=>{f.target===c&&ge(o)}),ft(c,s),q.set(o,{overlay:c,dialog:i}),{id:o,overlay:c,dialog:i}}function Wn(e){var n,a;const t=q.get(e);if(!t)throw new Error(`No existe un modal registrado con el id "${e}".`);ft(t.overlay),t.overlay.classList.add(`${Ue}--visible`),(a=(n=t.dialog).focus)==null||a.call(n),document.body.classList.add("modal-open")}function ge(e){const t=q.get(e);t&&(t.overlay.classList.remove(`${Ue}--visible`),document.body.classList.remove("modal-open"))}function Ne(e){const t=q.get(e);t&&(t.overlay.remove(),q.delete(e))}const jn=/^(PT|AF)-[A-Z0-9]{5}$/,Kn=(e=5)=>{const t="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let n="";for(let a=0;a<e;a+=1){const r=Math.floor(Math.random()*t.length);n+=t[r]}return n},qn=(e,t)=>{const n=e==="affiliate"?"AF":"PT",a=25,r=new Set(t.map(s=>typeof s.code=="string"?s.code:s.value).filter(Boolean));for(let s=0;s<a;s+=1){const o=`${n}-${Kn(5)}`;if(!r.has(o))return o}throw new Error("No fue posible generar un código único.")},ht=e=>{const t=e.code??e.value??e.id,n=e.role??(typeof t=="string"&&t.startsWith("AF")?"affiliate":"partner");return{id:e.id??e.codeId??e.code_id??t,code:t,role:n,owner_user_id:e.owner_user_id??e.userId??e.user_id??"",owner_name:e.owner_name??e.ownerName??e.owner??"",email:e.email??"",phone:e.phone??"",region:e.region??e.partner_region??"",parent_partner_id:e.parent_partner_id??e.partnerId??e.partner_id??"",status:e.status??"active",uses:e.uses??e.usage_count??0,max_uses:e.max_uses??e.maxUses??null,created_at:e.created_at??e.createdAt??null,updated_at:e.updated_at??e.updatedAt??null,raw:e}},Se=(e,t)=>{const n=document.createElement("article");if(n.className="card",e){const a=document.createElement("h2");a.textContent=e,n.appendChild(a)}if(t){const a=document.createElement("p");a.textContent=t,n.appendChild(a)}return n},Yn=e=>{const t=document.createElement("thead"),n=document.createElement("tr");return e.forEach(a=>{const r=document.createElement("th");r.textContent=a,n.appendChild(r)}),t.appendChild(n),t},Gn=(e,t)=>{const n=document.createElement("tr");[e.id??"—",e.code??"—",e.role==="affiliate"?"Afiliado":"Partner",e.owner_name||e.owner_user_id||"—",e.status??"—",e.max_uses?`${e.uses??0}/${e.max_uses}`:`${e.uses??0}`,e.region||"—"].forEach(s=>{const o=document.createElement("td");o.textContent=s,n.appendChild(o)});const r=document.createElement("td");if(e.raw&&e.raw.role){const s=document.createElement("button");s.type="button",s.textContent="Editar",s.className="button button--secondary",s.addEventListener("click",()=>t(e.raw)),r.appendChild(s)}else{const s=document.createElement("span");s.textContent="Solo lectura",s.className="tag",r.appendChild(s)}return n.appendChild(r),n},Xn=(e,t)=>{const n=document.createElement("table");n.appendChild(Yn(["ID","Código","Rol","Owner","Status","Usos","Región","Acciones"]));const a=document.createElement("tbody");if(e.length)e.map(r=>ht(r)).forEach(r=>{a.appendChild(Gn(r,t))});else{const r=document.createElement("tr"),s=document.createElement("td");s.colSpan=8,s.textContent="Sin códigos registrados.",r.appendChild(s),a.appendChild(r)}return n.appendChild(a),n},gt=e=>{const t=new FormData(e);return Object.fromEntries(t.entries())},Jn=e=>{ne(t=>{const n={...t},a=Array.isArray(n.codes)?[...n.codes]:[];return a.push(e),n.codes=a,n})},kn=(e,t)=>{let n=!1;return ne(a=>{const r={...a};return r.codes=Array.isArray(a.codes)?a.codes.map(s=>{const o=s.id??s.codeId??s.code_id;return o&&o===e?(n=!0,{...s,...t,updated_at:new Date().toISOString()}):s}):a.codes,r}),n},Qn=(e,t)=>{const n=document.createElement("form");if(n.className="form-grid",[{name:"owner_name",label:"Nombre",value:e.owner_name??""},{name:"owner_user_id",label:"ID usuario",value:e.owner_user_id??""},{name:"email",label:"Email",value:e.email??""},{name:"phone",label:"Teléfono",value:e.phone??""},{name:"region",label:"Región",value:e.region??""}].forEach(({name:i,label:p,value:l})=>{const u=document.createElement("label");u.textContent=p;const d=document.createElement("input");d.name=i,d.value=l,d.className="form-control",u.appendChild(d),n.appendChild(u)}),e.role==="affiliate"){const i=document.createElement("label");i.textContent="Partner padre";const p=document.createElement("input");p.name="parent_partner_id",p.value=e.parent_partner_id??"",p.required=!0,p.className="form-control",i.appendChild(p),n.appendChild(i)}const r=document.createElement("label");r.textContent="Status";const s=document.createElement("select");s.name="status",s.className="form-control",["active","inactive","paused","expired"].forEach(i=>{const p=document.createElement("option");p.value=i,p.textContent=i,(e.status??"active")===i&&(p.selected=!0),s.appendChild(p)}),r.appendChild(s),n.appendChild(r);const o=document.createElement("label");o.textContent="Máximo de usos";const c=document.createElement("input");return c.type="number",c.name="max_uses",c.min="0",e.max_uses!=null&&(c.value=Number(e.max_uses)),c.className="form-control",o.appendChild(c),n.appendChild(o),n.addEventListener("submit",i=>{i.preventDefault();const p=gt(n);t(p)}),n},Zn=(e,t)=>{const n=`edit-code-${e.id??e.codeId??e.code_id}`;Ne(n);const a=Qn(ht(e),s=>{const o={owner_name:s.owner_name??"",owner_user_id:s.owner_user_id??"",email:s.email??"",phone:s.phone??"",region:s.region??"",status:s.status??"active",parent_partner_id:e.role==="affiliate"?s.parent_partner_id??"":null,max_uses:s.max_uses?Number(s.max_uses):null};kn(e.id??e.codeId??e.code_id,o),v("Código actualizado correctamente",{type:"success"}),ge(n),Ne(n),t()}),r=Vn({id:n,title:`Editar código ${e.code??e.value}`,content:a,actions:[{label:"Cerrar",variant:"secondary",onClick:()=>{ge(n),Ne(n)}}]});Wn(r.id)},ea=(e,t)=>{const n=document.createElement("form");n.className="form-grid";const a=document.createElement("label");a.textContent="Rol";const r=document.createElement("select");r.name="role",r.required=!0,r.className="form-control",[{value:"partner",label:"Partner (PT)"},{value:"affiliate",label:"Affiliate (AF)"}].forEach(I=>{const g=document.createElement("option");g.value=I.value,g.textContent=I.label,r.appendChild(g)}),a.appendChild(r),n.appendChild(a);const o=document.createElement("label");o.textContent="Owner user id";const c=document.createElement("input");c.name="owner_user_id",c.required=!0,c.placeholder="USR-123",c.className="form-control",o.appendChild(c),n.appendChild(o);const i=document.createElement("label");i.textContent="Nombre";const p=document.createElement("input");p.name="owner_name",p.required=!0,p.placeholder="Nombre del responsable",p.className="form-control",i.appendChild(p),n.appendChild(i);const l=document.createElement("label");l.textContent="Email";const u=document.createElement("input");u.type="email",u.name="email",u.required=!0,u.placeholder="correo@empresa.com",u.className="form-control",l.appendChild(u),n.appendChild(l);const d=document.createElement("label");d.textContent="Teléfono";const m=document.createElement("input");m.name="phone",m.placeholder="+52 55 1234 5678",m.className="form-control",d.appendChild(m),n.appendChild(d);const f=document.createElement("label");f.textContent="Región";const h=document.createElement("input");h.name="region",h.placeholder="LatAm, Europa...",h.className="form-control",f.appendChild(h),n.appendChild(f);const C=document.createElement("label");C.textContent="Partner padre";const E=document.createElement("input");E.name="parent_partner_id",E.placeholder="PT-0001",E.className="form-control",C.appendChild(E),n.appendChild(C);const N=document.createElement("label");N.textContent="Máximo de usos";const _=document.createElement("input");_.type="number",_.name="max_uses",_.min="0",_.placeholder="Ej. 100",_.className="form-control",N.appendChild(_),n.appendChild(N);const w=document.createElement("p");return w.className="form-helper",w.textContent="Para afiliados es obligatorio especificar el partner padre.",n.appendChild(w),n.addEventListener("submit",I=>{I.preventDefault();const g=gt(n),y=g.role;if(!y){v("Debe seleccionar un rol válido.",{type:"warning"});return}if(y==="affiliate"&&!g.parent_partner_id){v("Los afiliados requieren un partner padre.",{type:"warning"});return}const A=$();let S;try{S=qn(y,Array.isArray(A.codes)?A.codes:[])}catch(yt){v(yt.message,{type:"danger"});return}if(!jn.test(S)){v("El formato generado del código no es válido.",{type:"danger"});return}const T=new Date().toISOString(),x={id:S,code:S,role:y,owner_user_id:g.owner_user_id,owner_name:g.owner_name,email:g.email,phone:g.phone??"",region:g.region??"",parent_partner_id:y==="affiliate"?g.parent_partner_id:null,max_uses:g.max_uses?Number(g.max_uses):null,status:"active",uses:0,created_at:T,updated_at:T};Jn(x),v(`Código ${x.code} creado exitosamente`,{type:"success"}),n.reset(),t()}),r.addEventListener("change",()=>{r.value==="affiliate"?(C.style.display="flex",E.required=!0):(C.style.display="none",E.required=!1,E.value="")}),r.dispatchEvent(new Event("change")),n};function ta(e,{refresh:t}){const n=$(),a=Array.isArray(n.codes)?n.codes:[],r=Se("Gestión de códigos","Crear códigos PT/AF, revisar su estado y actualizar información clave de los responsables.");e.appendChild(r);const s=Se("Nuevo código","Complete los datos para generar un nuevo código.");s.appendChild(ea(a,t)),e.appendChild(s);const o=Se("Listado de códigos");o.appendChild(Xn(a,c=>Zn(c,t))),e.appendChild(o)}const ce=(e,t)=>{const n=document.createElement("article");if(n.className="card",e){const a=document.createElement("h2");a.textContent=e,n.appendChild(a)}if(t){const a=document.createElement("p");a.textContent=t,n.appendChild(a)}return n},na=e=>{if(!e||e==="unknown")return"Sin dato";const[t,n]=e.split("-");return new Date(Date.UTC(Number(t),Number(n)-1,1)).toLocaleDateString("es-MX",{month:"short",year:"numeric"})},aa=e=>{const t=new Map;return e.forEach(n=>{const a=typeof(n==null?void 0:n.type)=="string"&&n.type.trim()?n.type.trim():"Sin clasificar";t.set(a,(t.get(a)??0)+1)}),Array.from(t.entries()).map(([n,a])=>({label:n,value:a}))};function ra(e){const t=$(),n=Me(t),a=ce("Reportes del sistema","Visualización de cuentas por tipo y región, además de la evolución mensual de usuarios.");e.appendChild(a);const r=document.createElement("div");r.className="grid grid--two";const s=ce("Usuarios por tipo de cuenta"),o=document.createElement("canvas");o.height=260,s.appendChild(o),r.appendChild(s);const c=ce("Usuarios por región"),i=document.createElement("canvas");i.height=260,c.appendChild(i),r.appendChild(c),e.appendChild(r);const p=ce("Serie mensual consolidada"),l=document.createElement("canvas");l.height=280,p.appendChild(l),e.appendChild(p),Te(o,aa(t.users??[])),Te(i,n.byRegion.map(d=>({label:d.region,value:d.users})));const u=n.byMonth.slice(-12).map(d=>({label:na(d.month),value:d.users}));_e(l,u)}const De=e=>Array.isArray(e)?e:[],oa=e=>{if(e==null||e==="")return null;const t=Number(e);return Number.isFinite(t)?t:null},ie=e=>{const t=Number(e);return Number.isFinite(t)?Math.round(t*100)/100:0},P=e=>e==null?null:typeof e=="number"?e:typeof e=="string"?e.trim():null,Be=e=>{try{return ae(e)}catch{return"unknown"}},sa=e=>P((e==null?void 0:e.id)??(e==null?void 0:e.partnerId)??(e==null?void 0:e.partner_id)??(e==null?void 0:e.code)),la=e=>P((e==null?void 0:e.partnerId)??(e==null?void 0:e.partner_id)??(e==null?void 0:e.parentPartnerId)??(e==null?void 0:e.parent_partner_id)),ca=e=>P((e==null?void 0:e.affiliateId)??(e==null?void 0:e.affiliate_id)??(e==null?void 0:e.id)??(e==null?void 0:e.code)??(e==null?void 0:e.identifier)),qe=(e,t)=>`${e}::${t??"unknown"}`,ia=(e,t)=>{const n=typeof e=="string"?e.replace(/[^0-9A-Z-]/gi,""):"PERIOD",a=typeof t=="string"?t.replace(/[^0-9A-Z-]/gi,""):t,r=a?String(a).toUpperCase():"PARTNER";return`INV-${n.toUpperCase()}-${r}`},da=e=>{var n,a,r,s,o,c,i,p,l,u,d,m,f,h;const t=[e==null?void 0:e.cutoff_day,e==null?void 0:e.cutoffDay,(n=e==null?void 0:e.settings)==null?void 0:n.cutoff_day,(a=e==null?void 0:e.settings)==null?void 0:a.cutoffDay,(s=(r=e==null?void 0:e.settings)==null?void 0:r.billing)==null?void 0:s.cutoff_day,(c=(o=e==null?void 0:e.settings)==null?void 0:o.billing)==null?void 0:c.cutoffDay,(i=e==null?void 0:e.billing)==null?void 0:i.cutoff_day,(p=e==null?void 0:e.billing)==null?void 0:p.cutoffDay,(l=e==null?void 0:e.config)==null?void 0:l.cutoff_day,(u=e==null?void 0:e.config)==null?void 0:u.cutoffDay,(m=(d=e==null?void 0:e.config)==null?void 0:d.billing)==null?void 0:m.cutoff_day,(h=(f=e==null?void 0:e.config)==null?void 0:f.billing)==null?void 0:h.cutoffDay];for(const C of t){const E=oa(C);if(E!=null&&E>=1&&E<=31)return Math.floor(E)}return 15},ua=(e,t)=>{if(typeof e!="string"||!/^[0-9]{4}-[0-9]{2}$/.test(e))return ee(new Date);const[n,a]=e.split("-"),r=Number(n),s=Number(a)-1,o=new Date(Date.UTC(r,s+1,t));return ee(o)},pa=(e,t,n)=>{const a=De(n==null?void 0:n.affiliates).filter(d=>{const m=la(d);return m!=null&&m===e}),r=new Set(a.map(d=>ca(d)).filter(Boolean)),s=De(n==null?void 0:n.users).filter(d=>{const m=P((d==null?void 0:d.partnerId)??(d==null?void 0:d.partner_id)??(d==null?void 0:d.parent_partner_id));return m==null||m!==e?!1:Be((d==null?void 0:d.createdAt)??(d==null?void 0:d.created_at)??(d==null?void 0:d.joinedAt))===t});let o=0,c=0,i=0,p=0,l=0;for(const d of s){const m=Le(d,n),f=P((d==null?void 0:d.affiliateId)??(d==null?void 0:d.affiliate_id)??(d==null?void 0:d.parent_affiliate_id));f!=null&&r.has(f)?(c+=1,p+=m.partner,l+=m.affiliate):(o+=1,i+=m.partner)}const u=ie(i+p);return{directUsers:o,affiliateUsers:c,totalUsers:o+c,directPartnerPayout:ie(i),affiliatePartnerPayout:ie(p),affiliateAffiliatePayout:ie(l),amount:u}},He=e=>(Array.isArray(e.invoices)||(e.invoices=[]),e.invoices),Oe=e=>({...e});function ma(e,t={}){const n=He(t),a=e??new Date,r=ae(a),s=da(t),o=ee(a),c=new Set(n.map(l=>{const u=(l==null?void 0:l.period)??Be((l==null?void 0:l.cutoff_date)??(l==null?void 0:l.created_at)),d=P((l==null?void 0:l.partner_id)??(l==null?void 0:l.partnerId)??(l==null?void 0:l.partner));return qe(u,d)})),i=new Set(n.map(l=>P((l==null?void 0:l.id)??(l==null?void 0:l.invoiceId)??(l==null?void 0:l.invoice_id))).filter(l=>l!=null)),p=[];for(const l of De(t==null?void 0:t.partners)){const u=sa(l);if(u==null)continue;const d=qe(r,u);if(c.has(d))continue;const m=pa(u,r,t);let f=ia(r,u),h=f,C=1;for(;i.has(h);)C+=1,h=`${f}-${C}`;i.add(h),c.add(d);const E={id:h,partner_id:u,partner_name:(l==null?void 0:l.name)??(l==null?void 0:l.shortName)??null,period:r,cutoff_date:o,due_date:ua(r,s),cutoff_day:s,amount:m.amount,payout_direct:m.directPartnerPayout,payout_from_affiliates:m.affiliatePartnerPayout,affiliate_payout:m.affiliateAffiliatePayout,users_count:m.totalUsers,status:"pending",created_at:new Date().toISOString()};n.push(E),p.push(Oe(E))}return p}function Y(e={},t={}){const n=He(t),a=(()=>{if(e.status==null)return null;const c=(Array.isArray(e.status)?e.status:[e.status]).map(i=>typeof i=="string"?i.trim().toLowerCase():null).filter(Boolean);return c.length===0?null:new Set(c)})(),r=!e.partnerId&&!e.partner_id&&!e.partner?null:P(e.partnerId??e.partner_id??e.partner),s=typeof e.period=="string"?e.period.trim():null;return n.filter(o=>{if(a){const c=typeof(o==null?void 0:o.status)=="string"?o.status.toLowerCase():"";if(!a.has(c))return!1}return!(r&&P((o==null?void 0:o.partner_id)??(o==null?void 0:o.partnerId)??(o==null?void 0:o.partner))!==r||s&&((o==null?void 0:o.period)??Be((o==null?void 0:o.cutoff_date)??(o==null?void 0:o.created_at)))!==s)}).map(Oe)}function Ct(e,t,n={}){if(e==null)throw new Error("An invoice id is required to update status.");if(t==null||typeof t=="string"&&t.trim()==="")throw new Error("A valid status value is required.");const a=He(n),r=P(e),o=(typeof t=="string"?t:String(t??"")).trim();if(!o)throw new Error("A valid status value is required.");const c=a.find(i=>{const p=P((i==null?void 0:i.id)??(i==null?void 0:i.invoiceId)??(i==null?void 0:i.invoice_id));return p!=null&&p===r});return c?(c.status=o,c.updated_at=new Date().toISOString(),Oe(c)):null}let O=null;const j=new Intl.NumberFormat("es-MX",{style:"currency",currency:"USD",maximumFractionDigits:2}),pe=(e,t)=>{const n=document.createElement("article");if(n.className="card",e){const a=document.createElement("h2");a.textContent=e,n.appendChild(a)}if(t){const a=document.createElement("p");a.textContent=t,n.appendChild(a)}return n},fa=e=>{const t={total:e.length,pending:0,paid:0,amount:0};return e.forEach(n=>{(typeof n.status=="string"?n.status.toLowerCase():"unknown")==="paid"?t.paid+=1:t.pending+=1,t.amount+=Number(n.amount??0)}),t},ha=e=>{const t=document.createElement("ul");return t.className="summary-list",[{label:"Facturas generadas",value:e.total},{label:"Pendientes",value:e.pending},{label:"Pagadas",value:e.paid},{label:"Monto total",value:j.format(e.amount)}].forEach(a=>{const r=document.createElement("li");r.innerHTML=`<span>${a.label}</span><strong>${a.value}</strong>`,t.appendChild(r)}),t},ga=e=>{const t=pe(`Detalle factura ${(e==null?void 0:e.id)??""}`);if(!e){const s=document.createElement("p");return s.textContent="Selecciona una factura para ver el detalle.",t.appendChild(s),t}const n=document.createElement("div");n.className="invoice-detail",n.innerHTML=`
    <p><strong>Partner:</strong> ${e.partner_name??e.partner_id??"—"}</p>
    <p><strong>Período:</strong> ${e.period??"—"}</p>
    <p><strong>Monto:</strong> ${j.format(e.amount??0)}</p>
    <p><strong>Estado:</strong> ${e.status}</p>
    <p><strong>Usuarios:</strong> ${e.users_count??0}</p>
    <p><strong>Cut-off:</strong> ${e.cutoff_date??"—"} | <strong>Vence:</strong> ${e.due_date??"—"}</p>
  `,t.appendChild(n);const a=document.createElement("div");a.className="invoice-breakdown",a.innerHTML=`
    <h3>Breakdown</h3>
    <ul>
      <li><span>Directo</span><strong>${j.format(e.payout_direct??0)}</strong></li>
      <li><span>Afiliados</span><strong>${j.format(e.payout_from_affiliates??0)}</strong></li>
      <li><span>Payout afiliados</span><strong>${j.format(e.affiliate_payout??0)}</strong></li>
    </ul>
  `,t.appendChild(a);const r=document.createElement("p");return r.className="invoice-notes",r.textContent=e.notes??"Sin notas registradas para esta factura.",t.appendChild(r),t},Ca=(e,t,n)=>{const a=document.createElement("table"),r=document.createElement("thead"),s=document.createElement("tr");["Invoice","Partner","Período","Monto","Usuarios","Estado","Acciones"].forEach(c=>{const i=document.createElement("th");i.textContent=c,s.appendChild(i)}),r.appendChild(s),a.appendChild(r);const o=document.createElement("tbody");if(e.length)e.forEach(c=>{const i=document.createElement("tr");i.dataset.invoiceId=c.id,c.id===O&&i.classList.add("is-selected"),[c.id,c.partner_name??c.partner_id??"—",c.period??"—",j.format(c.amount??0),c.users_count??0,c.status??"—"].forEach(m=>{const f=document.createElement("td");f.textContent=m,i.appendChild(f)});const l=document.createElement("td");l.className="table-actions";const u=document.createElement("button");u.type="button",u.textContent="Pendiente",u.className="button button--secondary",u.addEventListener("click",m=>{m.stopPropagation(),n(c.id,"pending")}),l.appendChild(u);const d=document.createElement("button");d.type="button",d.textContent="Marcar pagada",d.className="button",d.addEventListener("click",m=>{m.stopPropagation(),n(c.id,"paid")}),l.appendChild(d),i.appendChild(l),i.addEventListener("click",()=>t(c)),o.appendChild(i)});else{const c=document.createElement("tr"),i=document.createElement("td");i.colSpan=7,i.textContent="No hay facturas generadas aún.",c.appendChild(i),o.appendChild(c)}return a.appendChild(o),a},Ea=(e,t,n)=>{let a=null;ne(r=>{const s={...r},o=Ct(e,t,s);if(o&&(a=o,t==="paid")){const c=Array.isArray(s.invoice_history)?[...s.invoice_history]:[];c.push({id:`${e}-${Date.now()}`,invoice_id:e,status:t,amount:o.amount,changed_at:new Date().toISOString(),partner_id:o.partner_id}),s.invoice_history=c}return s}),a?(v(`Factura ${e} actualizada a ${t}`,{type:"success"}),n()):v("No fue posible actualizar la factura seleccionada.",{type:"danger"})},ya=(e,t)=>{e.addEventListener("submit",n=>{n.preventDefault();const r=new FormData(e).get("cutoff_date");if(!r){v("Debe elegir una fecha de corte.",{type:"warning"});return}let s=[];ne(o=>{const c={...o};return s=ma(new Date(r),c)??[],c}),s.length?v(`Se generaron ${s.length} facturas.`,{type:"success"}):v("No se generaron nuevas facturas para ese período.",{type:"info"}),t()})};function _a(e,{refresh:t}){var f;const n=$(),a=Y({},n);(!O||!a.find(h=>h.id===O))&&(O=((f=a[0])==null?void 0:f.id)??null);const r=pe("Pagos e invoices","Genera facturas al corte, administra estados y revisa detalles de cada partner.");e.appendChild(r);const s=pe("Generar facturas","Seleccione fecha de corte para crear nuevas facturas."),o=document.createElement("form");o.className="form-grid";const c=document.createElement("label");c.textContent="Fecha de corte";const i=document.createElement("input");i.type="date",i.name="cutoff_date",i.required=!0,i.className="form-control",c.appendChild(i),o.appendChild(c);const p=document.createElement("div"),l=document.createElement("button");l.type="submit",l.textContent="Generar",l.className="button",p.appendChild(l),o.appendChild(p),s.appendChild(o),s.appendChild(ha(fa(a))),e.appendChild(s),ya(o,t);const u=pe("Bandeja de facturas","Actualiza estados y consulta las facturas generadas."),d=Ca(a,h=>{O=h.id,t()},(h,C)=>Ea(h,C,t));u.appendChild(d),e.appendChild(u);const m=a.find(h=>h.id===O)??null;e.appendChild(ga(m))}const wa=e=>{if(!e||e==="unknown")return"Sin dato";const[t,n]=e.split("-");return new Date(Date.UTC(Number(t),Number(n)-1,1)).toLocaleDateString("es-MX",{month:"short",year:"numeric"})};function ba(e){const t=$(),n=Y({},t),a=Me(t),r=n.reduce((u,d)=>{const m=Number(d.amount??0);(typeof d.status=="string"?d.status.toLowerCase():"")==="paid"?u.paid+=m:u.toPay+=m;const h=d.partner_id??d.partnerId??d.partner;return h&&u.partners.add(h),u},{toPay:0,paid:0,partners:new Set}),s=document.createElement("article");s.className="card",s.innerHTML=`
    <h1>Dashboard financiero ejecutivo</h1>
    <p>Visión consolidada de pagos pendientes, cumplidos y crecimiento mensual de usuarios.</p>
  `,e.appendChild(s);const o=document.createElement("section");o.className="card";const c=document.createElement("div");Re(c,[{label:"Por pagar",value:r.toPay,prefix:"$"},{label:"Pagado",value:r.paid,prefix:"$"},{label:"Partners activos",value:r.partners.size}]),o.appendChild(c),e.appendChild(o);const i=document.createElement("section");i.className="card",i.innerHTML="<h2>Usuarios activos por mes</h2>";const p=document.createElement("canvas");p.height=280,i.appendChild(p),e.appendChild(i);const l=a.byMonth.slice(-12).map(u=>({label:wa(u.month),value:u.users}));_e(p,l)}const me=new Intl.NumberFormat("es-MX",{style:"currency",currency:"USD",maximumFractionDigits:2}),$e=(e,t)=>{const n=document.createElement("article");if(n.className="card",e){const a=document.createElement("h2");a.textContent=e,n.appendChild(a)}if(t){const a=document.createElement("p");a.textContent=t,n.appendChild(a)}return n},Aa=e=>{const t=new Map;return e.forEach(n=>{const a=(n.partner_id??n.partnerId??n.partner??"unknown").toString(),r=n.partner_name??a??"—";t.has(a)||t.set(a,{partnerId:a,partnerName:r,pendingAmount:0,paidAmount:0,totalAmount:0,pendingCount:0,paidCount:0});const s=t.get(a),o=Number(n.amount??0);(typeof n.status=="string"?n.status.toLowerCase():"pending")==="paid"?(s.paidAmount+=o,s.paidCount+=1):(s.pendingAmount+=o,s.pendingCount+=1),s.totalAmount+=o}),Array.from(t.values()).sort((n,a)=>a.totalAmount-n.totalAmount)},Na=e=>{const t=document.createElement("table"),n=document.createElement("thead"),a=document.createElement("tr");["Partner","Pendiente","Pagado","Total"].forEach(s=>{const o=document.createElement("th");o.textContent=s,a.appendChild(o)}),n.appendChild(a),t.appendChild(n);const r=document.createElement("tbody");if(e.length)e.forEach(s=>{const o=document.createElement("tr");[`${s.partnerName} (${s.partnerId??"N/A"})`,`${me.format(s.pendingAmount)} · ${s.pendingCount} facturas`,`${me.format(s.paidAmount)} · ${s.paidCount} facturas`,me.format(s.totalAmount)].forEach(i=>{const p=document.createElement("td");p.textContent=i,o.appendChild(p)}),r.appendChild(o)});else{const s=document.createElement("tr"),o=document.createElement("td");o.colSpan=4,o.textContent="No hay facturas registradas.",s.appendChild(o),r.appendChild(s)}return t.appendChild(r),t},Sa=e=>{const t=document.createElement("ul");return t.className="summary-list",e.slice(0,5).forEach(n=>{const a=document.createElement("li"),r=typeof n.status=="string"?n.status.toLowerCase():"pending";a.innerHTML=`
      <span>${n.id} · ${n.partner_name??n.partner_id??"—"} (${r})</span>
      <strong>${me.format(n.amount??0)}</strong>
    `,t.appendChild(a)}),t};function $a(e){const t=$(),n=Y({},t),a=Aa(n),r=$e("Pagos consolidados","Distribución de montos por partner y resumen de las facturas más recientes.");e.appendChild(r);const s=$e("Totales por partner");s.appendChild(Na(a)),e.appendChild(s);const o=$e("Últimas facturas generadas");o.appendChild(Sa(n.sort((c,i)=>{const p=new Date(c.created_at??0).getTime();return new Date(i.created_at??0).getTime()-p}))),e.appendChild(o)}const Et=new Intl.NumberFormat("es-MX",{style:"currency",currency:"USD",maximumFractionDigits:2});let de="all",K=null;const fe=(e,t)=>{const n=document.createElement("article");if(n.className="card",e){const a=document.createElement("h2");a.textContent=e,n.appendChild(a)}if(t){const a=document.createElement("p");a.textContent=t,n.appendChild(a)}return n},Ye=(e,t,n)=>{let a=null;ne(r=>{const s={...r},o=Ct(e,t,s);if(o&&(a=o,t==="paid")){const c=Array.isArray(s.invoice_history)?[...s.invoice_history]:[];c.push({id:`${e}-${Date.now()}`,invoice_id:e,status:t,amount:o.amount,changed_at:new Date().toISOString(),partner_id:o.partner_id}),s.invoice_history=c}return s}),a?(v(`Factura ${e} actualizada a ${t}`,{type:"success"}),n()):v("No fue posible actualizar la factura.",{type:"danger"})},va=(e,t)=>{const n=document.createElement("table"),a=document.createElement("thead"),r=document.createElement("tr");["Factura","Partner","Período","Monto","Usuarios","Estado","Acciones"].forEach(o=>{const c=document.createElement("th");c.textContent=o,r.appendChild(c)}),a.appendChild(r),n.appendChild(a);const s=document.createElement("tbody");if(e.length)e.forEach(o=>{const c=document.createElement("tr");o.id===K&&c.classList.add("is-selected"),[o.id,o.partner_name??o.partner_id??"—",o.period??"—",Et.format(o.amount??0),o.users_count??0,o.status??"—"].forEach(d=>{const m=document.createElement("td");m.textContent=d,c.appendChild(m)});const p=document.createElement("td");p.className="table-actions";const l=document.createElement("button");l.type="button",l.textContent="En revisión",l.className="button button--secondary",l.addEventListener("click",d=>{d.stopPropagation(),Ye(o.id,"review",t)}),p.appendChild(l);const u=document.createElement("button");u.type="button",u.textContent="Pago aplicado",u.className="button",u.addEventListener("click",d=>{d.stopPropagation(),Ye(o.id,"paid",t)}),p.appendChild(u),c.appendChild(p),c.addEventListener("click",()=>{K=o.id,t()}),s.appendChild(c)});else{const o=document.createElement("tr"),c=document.createElement("td");c.colSpan=7,c.textContent="Sin facturas para este filtro.",o.appendChild(c),s.appendChild(o)}return n.appendChild(s),n},xa=e=>{const t=fe("Detalle operacional");if(!e){const a=document.createElement("p");return a.textContent="Selecciona una factura para ver su información.",t.appendChild(a),t}const n=document.createElement("ul");return n.className="summary-list",n.appendChild((()=>{const a=document.createElement("li");return a.innerHTML=`<span>Partner</span><strong>${e.partner_name??e.partner_id??"—"}</strong>`,a})()),n.appendChild((()=>{const a=document.createElement("li");return a.innerHTML=`<span>Período</span><strong>${e.period??"—"}</strong>`,a})()),n.appendChild((()=>{const a=document.createElement("li");return a.innerHTML=`<span>Monto</span><strong>${Et.format(e.amount??0)}</strong>`,a})()),n.appendChild((()=>{const a=document.createElement("li");return a.innerHTML=`<span>Estado</span><strong>${e.status}</strong>`,a})()),t.appendChild(n),t};function Ia(e,{refresh:t}){var u;const n=$(),r=Y(de==="all"?{}:{status:de},n);(!K||!r.find(d=>d.id===K))&&(K=((u=r[0])==null?void 0:u.id)??null);const s=fe("Bandeja operativa","Filtra facturas por estado y registra movimientos.");e.appendChild(s);const o=fe("Filtros"),c=document.createElement("label");c.textContent="Estado";const i=document.createElement("select");i.className="form-control",[{value:"all",label:"Todos"},{value:"pending",label:"Pendiente"},{value:"review",label:"En revisión"},{value:"paid",label:"Pagada"}].forEach(d=>{const m=document.createElement("option");m.value=d.value,m.textContent=d.label,d.value===de&&(m.selected=!0),i.appendChild(m)}),i.addEventListener("change",d=>{de=d.target.value,t()}),c.appendChild(i),o.appendChild(c),e.appendChild(o);const p=fe("Facturas");p.appendChild(va(r,t)),e.appendChild(p);const l=r.find(d=>d.id===K)??null;e.appendChild(xa(l))}const Ta=new Intl.NumberFormat("es-MX",{style:"currency",currency:"USD",maximumFractionDigits:2}),Ge=(e,t)=>{const n=document.createElement("article");if(n.className="card",e){const a=document.createElement("h2");a.textContent=e,n.appendChild(a)}if(t){const a=document.createElement("p");a.textContent=t,n.appendChild(a)}return n},Pa=(e,t)=>{const n=new Map;return t.forEach(a=>{n.set(a.id,a)}),e.filter(a=>(a.status??"").toLowerCase()==="paid").sort((a,r)=>new Date(r.changed_at??0)-new Date(a.changed_at??0)).map(a=>({...a,invoice:n.get(a.invoice_id)??null}))},Da=e=>{const t=document.createElement("table"),n=document.createElement("thead"),a=document.createElement("tr");["Factura","Partner","Monto","Fecha","Notas"].forEach(s=>{const o=document.createElement("th");o.textContent=s,a.appendChild(o)}),n.appendChild(a),t.appendChild(n);const r=document.createElement("tbody");if(e.length)e.forEach(s=>{const o=s.invoice??{},c=document.createElement("tr");[s.invoice_id,o.partner_name??o.partner_id??s.partner_id??"—",Ta.format(s.amount??o.amount??0),new Date(s.changed_at??Date.now()).toLocaleString(),o.notes??"Pago registrado"].forEach(p=>{const l=document.createElement("td");l.textContent=p,c.appendChild(l)}),r.appendChild(c)});else{const s=document.createElement("tr"),o=document.createElement("td");o.colSpan=5,o.textContent="Sin pagos confirmados.",s.appendChild(o),r.appendChild(s)}return t.appendChild(r),t};function La(e){const t=$(),n=Y({},t),a=Array.isArray(t.invoice_history)?t.invoice_history:[],r=Pa(a,n),s=Ge("Historial de pagos","Solo se muestran facturas con estado pagado.");e.appendChild(s);const o=Ge("Pagos confirmados");o.appendChild(Da(r)),e.appendChild(o)}const Ma=e=>{if(!e||e==="unknown")return"Sin dato";const[t,n]=e.split("-");return new Date(Date.UTC(Number(t),Number(n)-1,1)).toLocaleDateString("es-MX",{month:"short",year:"numeric"})},X=(e,t)=>{const n=document.createElement("article");if(n.className="card",e){const a=document.createElement("h2");a.textContent=e,n.appendChild(a)}if(t){const a=document.createElement("p");a.textContent=t,n.appendChild(a)}return n};function Ra(e){const t=$(),n=Array.isArray(t.partners)&&t.partners.length?t.partners[0]:null;if(!n){const m=X("Dashboard de partner");m.appendChild(document.createTextNode("No se encontró un partner configurado.")),e.appendChild(m);return}const a=An(n.id,t),r=(a==null?void 0:a.partner)??{id:n.id},s=X(`Hola ${r.shortName??r.name??r.id??n.shortName??n.name??n.id}`,"Resumen de usuarios directos y afiliados, además de los pagos acumulados.");e.appendChild(s);const o=X(),c=document.createElement("div");Re(c,[{label:"Usuarios directos",value:a.totals.users.direct},{label:"Usuarios afiliados",value:a.totals.users.affiliates},{label:"Payout total",value:a.totals.payouts.overall.total,prefix:"$"}]),o.appendChild(c),e.appendChild(o);const i=X("Distribución de payouts"),p=document.createElement("ul");p.className="summary-list",p.innerHTML=`
    <li><span>Directo</span><strong>$${a.totals.payouts.direct.total.toLocaleString("es-MX")}</strong></li>
    <li><span>Afiliados</span><strong>$${a.totals.payouts.fromAffiliates.total.toLocaleString("es-MX")}</strong></li>
    <li><span>Total</span><strong>$${a.totals.payouts.overall.total.toLocaleString("es-MX")}</strong></li>
  `,i.appendChild(p),e.appendChild(i);const l=X("Usuarios por mes"),u=document.createElement("canvas");u.height=280,l.appendChild(u),e.appendChild(l);const d=a.monthlySeries.slice(-12).map(m=>({label:Ma(m.month),value:m.users.total}));_e(u,d)}const Ce=(e,t)=>{const n=document.createElement("article");if(n.className="card",e){const a=document.createElement("h2");a.textContent=e,n.appendChild(a)}if(t){const a=document.createElement("p");a.textContent=t,n.appendChild(a)}return n},Fa=e=>{if(!e||typeof e!="object")return null;const t=e.code??e.value??e.id??null,n=typeof t=="string"?t.trim():t,a=typeof n=="string"?n.toUpperCase():n,r=typeof a=="string"&&a.startsWith("AF")?"affiliate":"partner",s=e.max_uses??e.maxUses??null,o=s==null||s===""?null:Number(s),c=e.uses??e.use_count??e.usage_count??e.current_uses??e.currentUses??0,i=Number(c),p=e.affiliateId??e.affiliate_id??e.parent_affiliate_id??e.parentAffiliateId??null,l=p==null||p===""?null:String(p).trim()||null;return{id:e.id??e.codeId??e.code_id??n??null,code:n??null,status:e.status??"active",type:r,affiliateId:l,maxUses:Number.isFinite(o)?o:null,uses:Number.isFinite(i)?i:0}},Ua=e=>{if(!e||typeof e!="object")return null;const t=e.id??e.affiliateId??e.affiliate_id??e.code??e.identifier??null;return t==null?null:{id:t,name:e.name??e.shortName??null,region:e.region??e.locale??null,status:e.status??null}},Ba=(e=[])=>e.reduce((t,n)=>(n.type==="affiliate"?t.af.push(n):t.pt.push(n),t),{pt:[],af:[]}),Xe=(e,t)=>{const n=Ce(e);if(!t.length)return n.appendChild(document.createTextNode("Sin códigos registrados.")),n;const a=document.createElement("ul");return a.className="summary-list",t.forEach(r=>{const s=document.createElement("li"),o=r.maxUses!=null?` · ${r.maxUses} usos`:"";s.innerHTML=`<span>${r.code??"—"}</span><strong>${r.status??"activo"}${o}</strong>`,a.appendChild(s)}),n.appendChild(a),n},Ha=(e,t)=>{const n=Ce("Afiliados activos","Resumen por afiliado sin exponer datos sensibles.");if(!e.length)return n.appendChild(document.createTextNode("No hay afiliados asociados.")),n;const a=document.createElement("table"),r=document.createElement("thead"),s=document.createElement("tr");["Afiliado","Región","Códigos","Usuarios"].forEach(c=>{const i=document.createElement("th");i.textContent=c,s.appendChild(i)}),r.appendChild(s),a.appendChild(r);const o=document.createElement("tbody");return e.forEach(c=>{const i=t.filter(d=>d.affiliateId===c.id),p=i.reduce((d,m)=>d+(m.uses??0),0),l=document.createElement("tr");[c.name??c.id,c.region??"—",i.length,p].forEach(d=>{const m=document.createElement("td");m.textContent=d,l.appendChild(m)}),o.appendChild(l)}),a.appendChild(o),n.appendChild(a),n};function Oa(e){const t=$(),n=Array.isArray(t.partners)&&t.partners.length?t.partners[0]:null;if(!n){const o=Ce("Mis códigos");o.appendChild(document.createTextNode("No se encontró un partner configurado.")),e.appendChild(o);return}const a=Array.isArray(t.codes)?t.codes.filter(o=>(o.partnerId??o.partner_id)===n.id).map(Fa).filter(Boolean):[],r=Ba(a),s=Array.isArray(t.affiliates)?t.affiliates.filter(o=>o.partnerId===n.id).map(Ua).filter(Boolean):[];e.appendChild(Ce("Mis códigos","Consulta el código maestro PT y los afiliados asociados sin mostrar información personal de usuarios finales.")),e.appendChild(Xe("Código PT",r.pt)),e.appendChild(Xe("Códigos AF",r.af)),e.appendChild(Ha(s,a))}const Z=new Intl.NumberFormat("es-MX",{style:"currency",currency:"USD",maximumFractionDigits:2});let z=null;const J=(e,t)=>{const n=document.createElement("article");if(n.className="card",e){const a=document.createElement("h2");a.textContent=e,n.appendChild(a)}if(t){const a=document.createElement("p");a.textContent=t,n.appendChild(a)}return n},za=e=>{if(!e||typeof e!="object")return null;const t=e.id??e.invoiceId??e.invoice_id??null;if(t==null)return null;const n=e.partner_id??e.partnerId??e.partner??null,a=n==null||n===""?null:String(n).trim()||null,r=Number(e.amount??0),s=Number(e.users_count??e.usersCount??e.userCount??0);return{id:t,partnerId:a,partnerName:e.partner_name??null,period:e.period??null,amount:Number.isFinite(r)?r:0,status:e.status??null,usersCount:Number.isFinite(s)?s:0,cutoffDate:e.cutoff_date??e.cutoffDate??null,dueDate:e.due_date??e.dueDate??null}},Va=e=>e.reduce((t,n)=>(t.count+=1,t.amount+=n.amount,(typeof n.status=="string"?n.status.toLowerCase():"")==="paid"?t.paid+=n.amount:t.pending+=n.amount,t),{count:0,amount:0,paid:0,pending:0}),Wa=e=>{const t=document.createElement("ul");return t.className="summary-list",t.innerHTML=`
    <li><span>Facturas</span><strong>${e.count}</strong></li>
    <li><span>Monto total</span><strong>${Z.format(e.amount)}</strong></li>
    <li><span>Pendiente</span><strong>${Z.format(e.pending)}</strong></li>
    <li><span>Pagado</span><strong>${Z.format(e.paid)}</strong></li>
  `,t},ja=(e,t)=>{const n=document.createElement("table"),a=document.createElement("thead"),r=document.createElement("tr");["Factura","Período","Monto","Estado","Usuarios"].forEach(o=>{const c=document.createElement("th");c.textContent=o,r.appendChild(c)}),a.appendChild(r),n.appendChild(a);const s=document.createElement("tbody");if(e.length)e.forEach(o=>{const c=document.createElement("tr");o.id===z&&c.classList.add("is-selected"),[o.id,o.period??"—",Z.format(o.amount??0),o.status??"—",o.usersCount??0].forEach(p=>{const l=document.createElement("td");l.textContent=p,c.appendChild(l)}),c.addEventListener("click",()=>t(o)),s.appendChild(c)});else{const o=document.createElement("tr"),c=document.createElement("td");c.colSpan=5,c.textContent="Sin facturas generadas.",o.appendChild(c),s.appendChild(o)}return n.appendChild(s),n},Ka=e=>{const t=J("Detalle de factura");if(!e)return t.appendChild(document.createTextNode("Selecciona una factura para ver el detalle.")),t;const n=document.createElement("ul");return n.className="summary-list",n.innerHTML=`
    <li><span>Período</span><strong>${e.period??"—"}</strong></li>
    <li><span>Monto</span><strong>${Z.format(e.amount??0)}</strong></li>
    <li><span>Estado</span><strong>${e.status??"—"}</strong></li>
    <li><span>Usuarios</span><strong>${e.usersCount??0}</strong></li>
    <li><span>Cut-off</span><strong>${e.cutoffDate??"—"}</strong></li>
    <li><span>Vencimiento</span><strong>${e.dueDate??"—"}</strong></li>
  `,t.appendChild(n),t};function qa(e,{refresh:t}){var i;const n=$(),a=Array.isArray(n.partners)&&n.partners.length?n.partners[0]:null;if(!a){const p=J("Mis pagos");p.appendChild(document.createTextNode("No se encontró un partner configurado.")),e.appendChild(p);return}const r=Y({partnerId:a.id},n).map(za).filter(Boolean);(!z||!r.find(p=>p.id===z))&&(z=((i=r[0])==null?void 0:i.id)??null),e.appendChild(J("Mis pagos","Consulta facturas relacionadas a tu partner. Toda la información es solo lectura."));const s=J("Resumen");s.appendChild(Wa(Va(r))),e.appendChild(s);const o=J("Facturas del partner");o.appendChild(ja(r,p=>{z=p.id,t==null||t()})),e.appendChild(o);const c=Ka(r.find(p=>p.id===z)??null);e.appendChild(c)}const Ya={admin:[{view:"dashboard",label:"Dashboard",render:Fn},{view:"codes",label:"Códigos",render:ta},{view:"reports",label:"Reportes",render:ra},{view:"payments",label:"Pagos",render:_a}],ejecutivo:[{view:"dashboard",label:"Dashboard",render:ba},{view:"payments",label:"Pagos",render:$a}],finanzas:[{view:"payments",label:"Pagos",render:Ia},{view:"history",label:"Historial",render:La}],partner:[{view:"dashboard",label:"Dashboard",render:Ra},{view:"my-code",label:"Mi código & afiliados",render:Oa},{view:"payments",label:"Pagos",render:qa}]},Je="admin",ke="dashboard",Ga=()=>{Kt(),nt(),Object.entries(Ya).forEach(([d,m])=>{en(d,m)});const e=document.querySelector("#app");if(!e)throw new Error("No se encontró el nodo raíz #app para montar la aplicación.");e.innerHTML="";const t=document.createElement("div");t.className="app";const n=document.createElement("header");n.className="content__header";const a=document.createElement("h1");a.textContent="Panel de referidos",n.appendChild(a);const r=document.createElement("p");r.className="content__subtitle",n.appendChild(r);const s=document.createElement("section");s.className="view-container";const o=document.createElement("main");o.id="content",o.className="content",o.appendChild(n),o.appendChild(s),Qt(s);const c=Jt({activeRole:Je,activeView:ke,getViewsForRole:oe,onRoleChange:d=>{var C;const f=(C=oe(d)[0])==null?void 0:C.id,h=ue(d,f);l(h),p(h)},onViewChange:(d,m)=>{const f=ue(d,m);l(f),p(f)},title:"Roles"}),i=c.element;i.id="sidebar",i.classList.add("sidebar"),t.appendChild(i),t.appendChild(o),e.appendChild(t);const p=({role:d,view:m})=>{const h=oe(d).find(C=>C.id===m);r.textContent=h!=null&&h.label?`Vista: ${h.label}`:""},l=({role:d,view:m})=>{c.setActiveRole(d,{views:oe(d)}),c.setActiveView(m)},u=ue(Je,ke);l(u),p(u)};Ga();
